<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Custom Tailwind Config -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#f0f7ff',
                            100: '#e6eef5',
                            200: '#d1e0ed',
                            300: '#a9c7d8',
                            400: '#7aa7c0',
                            500: '#0F4173',
                            600: '#0F4173',
                            700: '#0a3055',
                            800: '#0c2548',
                            900: '#091b36',
                            950: '#060f1d',
                        },
                        secondary: {
                            50: '#f5f8fa',
                            100: '#e1f5fe',
                            200: '#b3e5fc',
                            300: '#81d4fa',
                            400: '#4fc3f7',
                            500: '#29b6f6',
                            600: '#00bcd4',
                            700: '#0097a7',
                            800: '#00838f',
                            900: '#006064',
                            950: '#004d40',
                        },
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    boxShadow: {
                        'soft': '0 2px 15px 0 rgba(0, 0, 0, 0.05)',
                        'medium': '0 4px 20px 0 rgba(0, 0, 0, 0.1)',
                    },
                },
            },
        }
    </script>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css">

    <!-- Google Material Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <style>
        .message-container {
            display: flex;
            margin-bottom: 15px;
            align-items: flex-start;
        }

        .profile-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            margin-right: 10px;
            overflow: hidden;
            flex-shrink: 0;
        }

        .profile-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .avatar-initials {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background-color: #0F4173;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
            margin-right: 10px;
        }

        .visitor-avatar {
            background-color: #e6eef5;
            color: #0F4173;
            border: 1px solid #d1e0ed;
            margin-right: 0;
            margin-left: 10px;
        }

        .ai-avatar {
            background-color: #e1f5fe;
            color: #00bcd4;
            border: 1px solid #b3e5fc;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .ai-avatar .material-icons {
            font-size: 18px;
        }

        .justify-end {
            justify-content: flex-end;
        }

        /* Message header styling */
        .message-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
            align-items: baseline;
        }

        .message-sender {
            font-size: 12px;
            font-weight: 600;
            color: inherit;
            opacity: 0.9;
        }

        .message-time {
            font-size: 10px !important;
            opacity: 0.7;
            margin-left: 8px;
            white-space: nowrap;
        }

        /* Typing indicator styles */
        .typing-indicator {
            display: none;
            margin-bottom: 10px;
            align-items: center;
            margin-top: 16px; /* Add spacing above typing indicators */
            position: relative; /* For positioning */
        }

        .typing-indicator.admin-typing,
        .typing-indicator.ai-typing {
            justify-content: flex-start;
        }

        .typing-indicator.visitor-typing {
            justify-content: flex-end;
        }

        .typing-bubble {
            padding: 10px 15px;
            border-radius: 18px;
            position: relative;
            max-width: 75%;
            margin: 0 8px;
            background-color: #ffffff; /* White background for all typing bubbles */
            border: 1px solid #e9ecef; /* Light border */
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05); /* Subtle shadow */
        }

        .typing-bubble .message-sender {
            font-size: 12px;
            margin-bottom: 3px;
            font-weight: 500;
            opacity: 0.8;
            color: #6c757d; /* Gray text for sender name */
        }

        .typing-bubble.admin-typing {
            border-top-right-radius: 4px;
        }

        .typing-bubble.ai-typing {
            border-top-right-radius: 4px;
        }

        .typing-bubble.visitor-typing {
            border-top-left-radius: 4px;
        }

        .typing-bubble .dots {
            display: inline-flex;
            align-items: center;
        }

        .typing-bubble .dot {
            height: 6px;
            width: 6px;
            border-radius: 50%;
            background-color: #adb5bd; /* Medium gray dots */
            margin: 0 2px;
            animation: typingAnimation 1.4s infinite;
            display: inline-block;
        }

        .typing-bubble .dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-bubble .dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typingAnimation {
            0%, 60%, 100% {
                transform: translateY(0);
            }
            30% {
                transform: translateY(-4px);
            }
        }

        /* System message styles - UPDATED */
        .system-message {
            display: flex;
            justify-content: center;
            margin: 16px 0;
            padding: 0 15px;
            width: 100%;
            box-sizing: border-box;
        }

        .system-message-content {
            background-color: #ffffff;
            color: #6c757d;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 13px;
            text-align: center;
            border: 1px solid #e9ecef;
            max-width: 80%;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            display: inline-block;
        }

        .system-message-time {
            margin-left: 8px;
            opacity: 0.6;
            font-size: 11px;
            display: inline-block;
        }

        /* Welcome message style */
        .welcome-message {
            margin: 20px 0 30px;
            padding: 15px;
            background-color: #f8f9fa;
            border-left: 4px solid #0F4173;
            border-radius: 6px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        /* User details banner styles */
        .user-details-banner {
            background-color: #f0f7ff;
            border-radius: 8px;
            padding: 12px 16px;
            margin-bottom: 16px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .user-details-banner .banner-text {
            display: flex;
            align-items: center;
            color: #0F4173;
            font-weight: 500;
        }

        .user-details-banner .banner-text i {
            margin-right: 8px;
            font-size: 16px;
        }

        .user-details-banner .add-details-btn {
            background-color: #0F4173;
            color: white;
            border-radius: 6px;
            padding: 6px 12px;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .user-details-banner .add-details-btn:hover {
            background-color: #0a3055;
            transform: translateY(-1px);
        }

        /* Updated message styles for the new color scheme */
        .bg-primary-600 {
            background-color: #0F4173 !important;
        }

        .bg-primary-700 {
            background-color: #0a3055 !important;
        }

        .bg-primary-100 {
            background-color: #e6eef5 !important;
        }

        .text-primary-900 {
            color: #333333 !important;
        }

        .text-primary-600 {
            color: #0F4173 !important;
        }

        .text-primary-800 {
            color: #0a3055 !important;
        }

        .focus\:ring-primary-500:focus {
            --tw-ring-color: #0F4173 !important;
        }

        .focus\:border-primary-500:focus {
            border-color: #0F4173 !important;
        }

        /* Enhanced message input field styling */
        .message-input-field {
            border: 2px solid #e6eef5 !important;
            transition: all 0.3s ease !important;
        }

        .message-input-field:focus {
            border-color: #0F4173 !important;
            box-shadow: 0 0 0 3px rgba(15, 65, 115, 0.2) !important;
        }

        /* Send button styling */
        .send-button {
            background-color: #0F4173 !important;
            transition: all 0.3s ease !important;
            position: relative;
            overflow: hidden;
        }

        .send-button:hover {
            background-color: #0a3055 !important;
            transform: translateY(-2px) !important;
            box-shadow: 0 4px 8px rgba(15, 65, 115, 0.3) !important;
        }

        .send-button:active {
            transform: translateY(0) !important;
        }

        .send-button i {
            transition: all 0.3s ease !important;
        }

        .send-button:hover i {
            transform: translateX(2px) !important;
        }

        /* Enhanced "Add your details" styling */
        .add-details-link {
            display: inline-flex !important;
            align-items: center !important;
            justify-content: center !important;
            padding: 8px 16px !important;
            background-color: #f0f7ff !important;
            border: 1px solid #d1e0ed !important;
            border-radius: 20px !important;
            color: #0F4173 !important;
            font-weight: 500 !important;
            transition: all 0.3s ease !important;
            animation: pulse 2s infinite !important;
            box-shadow: 0 2px 5px rgba(15, 65, 115, 0.1) !important;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .add-details-link:hover {
            background-color: #e6eef5 !important;
            text-decoration: none !important;
            animation: none !important;
            transform: translateY(-1px) !important;
            box-shadow: 0 4px 8px rgba(15, 65, 115, 0.2) !important;
        }

        .add-details-icon {
            margin-right: 8px !important;
            font-size: 14px !important;
        }

        /* Add modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
        }

        .modal-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #888;
            border-radius: 12px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            animation: modalAppear 0.3s ease-out;
        }

        @keyframes modalAppear {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .close-modal {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.2s;
        }

        .close-modal:hover,
        .close-modal:focus {
            color: #333;
            text-decoration: none;
            cursor: pointer;
        }

        .modal h3 {
            margin-top: 0;
            color: #d32f2f;
            font-size: 1.25rem;
        }

        .modal-btn {
            background-color: #0F4173;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .modal-btn:hover {
            background-color: #0a3055;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        .modal-btn:active {
            transform: translateY(0);
        }

        .sad-face-emoji {
            font-size: 3rem;
            line-height: 1;
            animation: sadFaceBounce 2s infinite;
        }

        @keyframes sadFaceBounce {
            0%, 100% { transform: translateY(0); }
            20% { transform: translateY(-10px); }
            40% { transform: translateY(0); }
        }

        #no-admin-message {
            font-size: 1.1rem;
            color: #555;
            line-height: 1.4;
        }

        .text-center {
            text-align: center;
        }

        .mb-2 {
            margin-bottom: 0.5rem;
        }

        .mb-3 {
            margin-bottom: 0.75rem;
        }

        .mb-4 {
            margin-bottom: 1rem;
        }

        .text-red-500 {
            color: #ef4444;
        }

        .font-bold {
            font-weight: 700;
        }

        .text-sm {
            font-size: 0.875rem;
        }

        .text-gray-600 {
            color: #4b5563;
        }
    </style>
</head>
<body class="bg-white overflow-hidden h-screen flex flex-col">
    <div class="flex flex-col h-full bg-white overflow-hidden">
        <!-- Chat Messages -->
        <div class="flex-grow overflow-y-auto p-4 bg-gray-50" id="message-container" room-id="{{ room.id }}" style="padding-bottom: 120px;">
            {% if not has_online_admins and room.chat_mode == 'human' %}
            <div class="bg-amber-50 border-l-4 border-amber-500 p-4 mb-4 rounded shadow-soft">
                <p class="text-amber-700">No support agent is currently available. Please leave a message and we will respond once we are active.</p>
                {% if not within_business_hours %}
                <p class="text-amber-700 mt-2">{{ away_message }}</p>
                {% endif %}
            </div>
            {% endif %}

            {% if room.chat_mode == 'ai' %}
            <div class="bg-blue-50 border-l-4 border-primary-500 p-4 mb-4 rounded shadow-soft">
                <p class="text-primary-700">You are currently chatting with our AI assistant. If you need to speak with a human agent, you can toggle the chat mode above.</p>
            </div>
            {% endif %}

            {% if messages|length > 0 %}
            <div class="space-y-4">
                {% for message in messages %}
                {% if message.is_system_message %}
                <!-- System message -->
                <div class="system-message">
                    <div class="system-message-content">
                        {{ message.content }}
                        <span class="system-message-time" data-timestamp="{{ message.timestamp.isoformat() }}">{{ format_time(message.timestamp) }}</span>
                    </div>
                </div>
                {% else %}
                <!-- Regular message -->
                <div class="message-container {% if message.is_from_visitor %}justify-end{% endif %}">
                    {% if not message.is_from_visitor %}
                        {% if message.is_ai_generated %}
                            <div class="avatar-initials ai-avatar">
                                <span class="material-icons">smart_toy</span>
                            </div>
                        {% else %}
                            {% if message.admin_profile_image %}
                                <div class="profile-avatar">
                                    <img src="{{ message.admin_profile_image }}" alt="{{ message.sender_name }}">
                                </div>
                            {% else %}
                                <div class="avatar-initials">
                                    {{ message.sender_name|default('A')|first|upper }}
                                </div>
                            {% endif %}
                        {% endif %}
                    {% endif %}

                    <div class="max-w-[75%] rounded-lg px-4 py-3 shadow-soft {% if message.is_from_visitor %}bg-primary-100 text-primary-900{% else %}{% if message.is_ai_generated %}bg-secondary-100 text-secondary-900{% else %}bg-primary-600 text-white{% endif %}{% endif %}">
                        <div class="flex flex-col">
                            <div class="message-header">
                                <span class="message-sender">
                                    {% if message.is_from_visitor %}
                                        You
                                    {% elif message.is_ai_generated %}
                                        AI Assistant
                                    {% else %}
                                        {{ message.sender_name or 'Support Agent' }}
                                    {% endif %}
                                </span>
                                <span class="message-time" data-timestamp="{{ message.timestamp.isoformat() }}" data-format="{{ time_format }}">
                                    {{ format_time(message.timestamp) }}
                                </span>
                            </div>
                            <p class="text-sm">{{ message.content }}</p>
                        </div>
                    </div>

                    {% if message.is_from_visitor %}
                        <div class="avatar-initials visitor-avatar">
                            You
                        </div>
                    {% endif %}
                </div>
                {% endif %}
                {% endfor %}
            </div>
            {% else %}
            <div class="welcome-message">
                <p class="text-gray-700 mb-2">{{ welcome_message }}</p>
                {% if room.chat_mode == 'ai' %}
                <p class="text-primary-600">{{ ai_welcome_message }}</p>
                {% endif %}
            </div>
            {% endif %}

            <!-- Typing indicators -->
            <div id="admin-typing-indicator" class="typing-indicator admin-typing">
                <div class="avatar-initials">
                    A
                </div>
                <div class="typing-bubble admin-typing">
                    <div class="message-sender admin-typing-name">Admin</div>
                    <div class="dots">
                        <span class="dot"></span>
                        <span class="dot"></span>
                        <span class="dot"></span>
                    </div>
                </div>
            </div>

            <div id="ai-typing-indicator" class="typing-indicator ai-typing">
                <div class="avatar-initials ai-avatar">
                    <span class="material-icons">smart_toy</span>
                </div>
                <div class="typing-bubble ai-typing">
                    <div class="message-sender">AI Assistant</div>
                    <div class="dots">
                        <span class="dot"></span>
                        <span class="dot"></span>
                        <span class="dot"></span>
                    </div>
                </div>
            </div>

            <div id="visitor-typing-indicator" class="typing-indicator visitor-typing">
                <div class="typing-bubble visitor-typing">
                    <div class="message-sender">You</div>
                    <div class="dots">
                        <span class="dot"></span>
                        <span class="dot"></span>
                        <span class="dot"></span>
                    </div>
                </div>
                <div class="avatar-initials visitor-avatar">
                    You
                </div>
            </div>
        </div>

        <!-- Message Input (fixed at bottom) -->
        <div class="border-t border-gray-200 p-4 bg-white fixed bottom-0 left-0 right-0 z-10">
            <div class="flex items-center space-x-2">
                <textarea id="message-input" class="message-input-field flex-grow border border-gray-300 rounded-lg py-2 px-3 focus:ring-2 focus:ring-primary-500 focus:border-primary-500 resize-none" placeholder="Type your message here..." rows="2"></textarea>
                <button id="send-message-btn" class="send-button bg-primary-600 hover:bg-primary-700 text-white rounded-lg p-3 transition-colors">
                    <i class="fa-solid fa-paper-plane"></i>
                </button>
            </div>
        </div>

        <!-- User Details Modal -->
        <div id="user-details-modal" class="fixed inset-0 flex items-center justify-center z-50 hidden">
            <div class="fixed inset-0 bg-black opacity-50"></div>
            <div class="bg-white rounded-lg p-6 w-80 relative z-10">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-medium text-gray-900">Your Details</h3>
                    <button id="close-modal" class="text-gray-400 hover:text-gray-500">
                        <span class="material-icons">close</span>
                    </button>
                </div>
                <div class="mb-5">
                    <div class="mb-4">
                        <label for="visitor-name" class="block text-sm font-medium text-gray-700 mb-1">Name</label>
                        <input type="text" id="visitor-name" class="message-input-field w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500" placeholder="Your name">
                    </div>
                    <div class="mb-4">
                        <label for="visitor-email" class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                        <input type="email" id="visitor-email" class="message-input-field w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500" placeholder="Your email address">
                        <p id="email-error" class="text-red-500 text-xs mt-1 hidden">Please enter a valid email address.</p>
                    </div>
                </div>
                <div class="flex justify-end space-x-3">
                    <button id="cancel-details" class="px-4 py-2 bg-gray-100 text-gray-700 rounded hover:bg-gray-200 focus:outline-none">
                            Cancel
                        </button>
                    <button id="save-user-details" class="send-button px-4 py-2 bg-primary-500 text-white rounded hover:bg-primary-600 focus:outline-none">
                        Save
                        </button>
                    </div>
                </div>
            </div>

        <!-- Add success modal -->
        <div id="success-modal" class="fixed inset-0 flex items-center justify-center z-50 hidden">
            <div class="fixed inset-0 bg-black opacity-50"></div>
            <div class="bg-white rounded-lg p-6 w-80 relative z-10">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-medium text-gray-900">Success</h3>
                    <button id="close-success-modal" class="text-gray-400 hover:text-gray-500">
                        <span class="material-icons">close</span>
                    </button>
                </div>
                <div class="mb-5">
                    <p id="success-message" class="text-gray-600">Your details have been saved. Thank you!</p>
                </div>
                <div class="mt-4 flex justify-end">
                    <button id="ok-success-btn" class="send-button px-4 py-2 bg-primary-500 text-white rounded hover:bg-primary-600 focus:outline-none">
                        OK
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script>
        // Connect to Socket.IO with reconnection settings
        var socket = io({
            reconnection: true,
            reconnectionAttempts: Infinity,
            reconnectionDelay: 1000,
            reconnectionDelayMax: 5000,
            timeout: 20000
        });
        var roomId = "{{ room.id }}";
        var visitorId = "{{ visitor_id }}";
        var currentChatMode = "{{ room.chat_mode }}";

        // Add page visibility and beforeunload event listeners
        document.addEventListener('visibilitychange', handleVisibilityChange);
        window.addEventListener('beforeunload', notifyDisconnect);

        // Function to handle visibility change
        function handleVisibilityChange() {
            if (document.visibilityState === 'hidden') {
                // User switched to another tab or minimized the window
                socket.emit('visitor_inactive', {
                    room_id: roomId,
                    visitor_id: visitorId,
                    status: 'inactive'
                });
            } else if (document.visibilityState === 'visible') {
                // User returned to this tab
                socket.emit('visitor_active', {
                    room_id: roomId,
                    visitor_id: visitorId,
                    status: 'active'
                });
            }
        }

        // Function to notify server when the user is about to close the tab/window
        function notifyDisconnect() {
            // Use navigator.sendBeacon for more reliable delivery during page unload
            if (navigator.sendBeacon) {
                const data = new FormData();
                data.append('room_id', roomId);
                data.append('visitor_id', visitorId);
                navigator.sendBeacon('/api/visitor_disconnect', data);
            } else {
                // Fallback to socket emit with a small delay
                socket.emit('visitor_disconnect', {
                    room_id: roomId,
                    visitor_id: visitorId
                });

                // Small delay to ensure message is sent
                const now = new Date().getTime();
                while (new Date().getTime() < now + 100) { /* wait */ }
            }
        }

        // Check if visitor has details (name or email)
        var hasVisitorName = "{{ visitor.name|default('') }}" !== "";
        var hasVisitorEmail = "{{ visitor.email|default('') }}" !== "";
        var visitorHasDetails = hasVisitorName || hasVisitorEmail;

        // Get elements for user details display
        var addDetailsBanner = document.getElementById('add-details-banner');
        var userDetailsDisplay = document.getElementById('user-details-display');

        // Initialize visibility on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Set up initial event listeners
            document.getElementById('edit-details-btn')?.addEventListener('click', function() {
                userDetailsModal.classList.remove('hidden');
            });

            document.getElementById('show-details-modal-btn')?.addEventListener('click', function(e) {
                e.preventDefault();
                userDetailsModal.classList.remove('hidden');
            });

            // Check if we need to update user details display based on localStorage
            if (localStorage.getItem('visitor_has_details') === 'true') {
                // Use localStorage values if available, otherwise fall back to server values
                const displayName = localStorage.getItem('visitor_name') || "{{ visitor.name|default('') }}";
                const displayEmail = localStorage.getItem('visitor_email') || "{{ visitor.email|default('') }}";

                // Update the display
                updateUserDetailsDisplay(displayName, displayEmail);
            }

            // Update all timestamps
            updateAllTimestamps();

            // Scroll to bottom
            scrollToBottom();
        });

        // Function to update or create the user details display
        function updateUserDetailsDisplay(name, email) {
            // Create banner HTML for when user doesn't have details
            const bannerHTML = `
                <div id="add-details-banner" class="user-details-banner">
                    <div class="banner-text">
                        <i class="fa-solid fa-user-pen"></i>
                        <span>Add your details to help us serve you better</span>
                    </div>
                    <button id="show-details-modal-btn" class="add-details-btn">
                        Add Details
                    </button>
                </div>
            `;

            // Get message container
            const messageContainer = document.getElementById('message-container');

            // Remove existing elements if they exist
            const existingDetails = document.getElementById('user-details-display');
            const existingBanner = document.getElementById('add-details-banner');

            if (existingDetails) {
                existingDetails.remove();
            }

            if (existingBanner) {
                existingBanner.remove();
            }

            // Only show banner if user doesn't have details
            // We no longer show the "Chatting as:" display in the chat area
            if (!name && !email) {
                // Insert banner
                messageContainer.insertAdjacentHTML('afterbegin', bannerHTML);

                // Add event listener to the add details button
                document.getElementById('show-details-modal-btn')?.addEventListener('click', function(e) {
                    e.preventDefault();
                    userDetailsModal.classList.remove('hidden');
                });
            }

            // Note: User details are now only shown in the header area, not in the chat
        }

        // Generate or retrieve browser UUID for visitor identification
        var browserUUID;

        // Check if browser UUID exists in localStorage
        browserUUID = localStorage.getItem('browser_uuid');

        // If not, generate a new UUID
        if (!browserUUID) {
            // Use crypto.randomUUID() if available (modern browsers)
            if (window.crypto && window.crypto.randomUUID) {
                browserUUID = window.crypto.randomUUID();
            } else {
                // Fallback for older browsers
                browserUUID = 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                    const r = Math.random() * 16 | 0;
                    const v = c === 'x' ? r : (r & 0x3 | 0x8);
                    return v.toString(16);
                });
            }

            // Store in localStorage for persistence
            localStorage.setItem('browser_uuid', browserUUID);
        }

        // Store visitor_id in localStorage for persistence across sessions
        localStorage.setItem('visitor_id', visitorId);

        // SESSION-BASED ROOM ISOLATION: Store room_id in sessionStorage with session-specific key
        // Generate session ID if not exists
        let sessionId = sessionStorage.getItem('session_id');
        if (!sessionId) {
            sessionId = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            sessionStorage.setItem('session_id', sessionId);
        }

        const sessionStorageKey = 'session_room_id_' + sessionId;
        sessionStorage.setItem(sessionStorageKey, roomId);

        // Get timezone and time format settings
        let timezone = "{{ timezone }}"; // Site default timezone
        const timeFormat = "{{ time_format }}";
        let currentTimeFormat = timeFormat; // Store current time format for real-time updates
        let userTimezone = null; // User's detected timezone
        let timezoneDetected = false; // Flag to track if timezone detection is complete

        // Detect user's timezone automatically - run immediately
        function detectUserTimezone() {
            try {
                // First, try to get timezone from browser
                userTimezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
                console.log('Detected user timezone:', userTimezone);

                // Test current time using Python backend
                fetch('/api/get_current_time', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        timezone: userTimezone,
                        format: '12h'
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        console.log('Current time in detected timezone (Python backend):', data.current_time);
                        console.log('ISO timestamp:', data.iso_timestamp);
                    } else {
                        console.error('Error getting current time:', data.error);
                    }
                })
                .catch(error => {
                    console.error('Error calling current time API:', error);
                });

                // Also test with JavaScript for comparison
                const testDate = new Date();
                const testTimeInUserTZ = new Intl.DateTimeFormat('en-US', {
                    hour: 'numeric',
                    minute: 'numeric',
                    hour12: true,
                    timeZone: userTimezone
                }).format(testDate);
                console.log('Current time in detected timezone (JavaScript):', testTimeInUserTZ);
                console.log('Current time in browser local:', testDate.toLocaleTimeString());

                // Update timezone to use user's local timezone
                timezone = userTimezone;
                timezoneDetected = true;

                // Show timezone indicator to user
                showTimezoneIndicator(userTimezone);

                // Update all timestamps with the new timezone
                updateAllTimestamps();

                // Optionally, try to get more precise location-based timezone
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        function(position) {
                            // Get timezone based on coordinates
                            getTimezoneFromCoordinates(position.coords.latitude, position.coords.longitude);
                        },
                        function(error) {
                            console.log('Geolocation error:', error.message);
                            // Continue with browser-detected timezone
                        },
                        {
                            timeout: 5000,
                            enableHighAccuracy: false
                        }
                    );
                }
            } catch (error) {
                console.error('Error detecting timezone:', error);
                // Fallback to site timezone
                timezone = "{{ timezone }}";
            }
        }

        // Get timezone from coordinates using a timezone API
        function getTimezoneFromCoordinates(lat, lng) {
            // Use a simple timezone detection based on coordinates
            // This is a basic implementation - you could use a more sophisticated API
            try {
                // For now, we'll stick with the browser-detected timezone
                // as it's usually accurate and doesn't require external API calls
                console.log('User location:', lat, lng);
                console.log('Using browser-detected timezone:', userTimezone);
            } catch (error) {
                console.error('Error getting timezone from coordinates:', error);
            }
        }

        // Show timezone indicator to user
        function showTimezoneIndicator(detectedTimezone) {
            try {
                // Create a subtle notification that times are shown in user's timezone
                const timezoneInfo = document.createElement('div');
                timezoneInfo.id = 'timezone-indicator';
                timezoneInfo.style.cssText = `
                    position: fixed;
                    top: 10px;
                    right: 10px;
                    background: rgba(15, 65, 115, 0.9);
                    color: white;
                    padding: 8px 12px;
                    border-radius: 6px;
                    font-size: 12px;
                    z-index: 1000;
                    opacity: 0;
                    transition: opacity 0.3s ease;
                    pointer-events: none;
                    max-width: 200px;
                    text-align: center;
                `;

                // Format timezone name for display
                const timezoneName = detectedTimezone.replace(/_/g, ' ').split('/').pop();
                timezoneInfo.innerHTML = `<i class="fas fa-clock" style="margin-right: 4px;"></i>Times shown in your timezone<br><small>${timezoneName}</small>`;

                document.body.appendChild(timezoneInfo);

                // Show the indicator
                setTimeout(() => {
                    timezoneInfo.style.opacity = '1';
                }, 100);

                // Hide after 4 seconds
                setTimeout(() => {
                    timezoneInfo.style.opacity = '0';
                    setTimeout(() => {
                        if (timezoneInfo.parentNode) {
                            timezoneInfo.parentNode.removeChild(timezoneInfo);
                        }
                    }, 300);
                }, 4000);
            } catch (error) {
                console.error('Error showing timezone indicator:', error);
            }
        }

        // Function to format timestamps using Python backend for accurate timezone conversion
        async function formatTimestamp(timestamp, format) {
            // Check if timestamp is valid
            if (!timestamp) {
                return '';
            }

            // Use user's detected timezone if available, otherwise use browser's local timezone
            const effectiveTimezone = userTimezone || timezone;

            console.log('formatTimestamp debug:', {
                timestamp: timestamp,
                format: format,
                effectiveTimezone: effectiveTimezone,
                userTimezone: userTimezone,
                timezone: timezone
            });

            try {
                // Use Python backend for accurate timezone conversion
                const response = await fetch('/api/format_time_for_timezone', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        timestamp: timestamp,
                        timezone: effectiveTimezone,
                        format: format
                    })
                });

                const data = await response.json();

                if (data.success) {
                    console.log('Formatted time with Python backend:', data.formatted_time);
                    return data.formatted_time;
                } else {
                    console.error('Backend formatting error:', data.error);
                    // Fall back to JavaScript formatting
                    return formatTimestampFallback(timestamp, format);
                }
            } catch (e) {
                console.error('Error calling backend for timestamp formatting:', e);
                // Fall back to JavaScript formatting
                return formatTimestampFallback(timestamp, format);
            }
        }

        // Fallback JavaScript formatting function
        function formatTimestampFallback(timestamp, format) {
            try {
                const date = new Date(timestamp);
                if (isNaN(date.getTime())) {
                    return '';
                }

                // Use browser's local time as fallback
                const fallbackTime = format === '12h'
                    ? date.toLocaleTimeString('en-US', { hour: 'numeric', minute: 'numeric', hour12: true })
                    : date.toLocaleTimeString('en-US', { hour: 'numeric', minute: 'numeric', hour12: false });

                console.log('Fallback time:', fallbackTime);
                return fallbackTime;
            } catch (e) {
                console.error('Error in fallback formatting:', e);
                return '';
            }
        }

        // Update all timestamps on the page (async version)
        async function updateAllTimestamps() {
            // Update message timestamps
            const messageTimeElements = document.querySelectorAll('.message-time');
            for (const element of messageTimeElements) {
                const timestamp = element.getAttribute('data-timestamp');
                const format = currentTimeFormat; // Use current time format instead of data-format
                if (timestamp) {
                    try {
                        const formattedTime = await formatTimestamp(timestamp, format);
                        if (formattedTime) {
                            element.textContent = formattedTime;
                        } else {
                            element.textContent = '';
                        }
                    } catch (e) {
                        console.error('Error updating timestamp:', e);
                        element.textContent = '';
                    }
                }
            }

            // Also update system message times
            const systemTimeElements = document.querySelectorAll('.system-message-time');
            for (const element of systemTimeElements) {
                const timestamp = element.getAttribute('data-timestamp');
                if (timestamp) {
                    try {
                        const formattedTime = await formatTimestamp(timestamp, currentTimeFormat);
                        if (formattedTime) {
                            element.textContent = formattedTime;
                        } else {
                            element.textContent = '';
                        }
                    } catch (e) {
                        console.error('Error updating system timestamp:', e);
                        element.textContent = '';
                    }
                }
            }
        }

        // Listen for settings updates
        socket.on('settings_updated', function(data) {
            console.log('Settings updated:', data);
            if (data.time_format) {
                currentTimeFormat = data.time_format;
                // Update all timestamps with the new format
                updateAllTimestamps();
            }
        });

        // Run timezone detection immediately (don't wait for DOMContentLoaded)
        detectUserTimezone();

        // Call timestamp update on page load as well
        document.addEventListener('DOMContentLoaded', function() {
            // Update timestamps again after DOM is ready
            updateAllTimestamps();
        });

        // Track connection status
        var isConnected = false;

        // Function to request notification permission
        function requestNotificationPermission() {
            if (!("Notification" in window)) {
                console.log("This browser does not support desktop notification");
            } else if (Notification.permission !== "denied") {
                Notification.requestPermission();
            }
        }

        // Request notification permission when page loads
        requestNotificationPermission();

        // Function to show browser notification
        function showNotification(title, message) {
            // Only show notification if the page is not visible (minimized/background)
            if (document.visibilityState !== 'visible' && Notification.permission === "granted") {
                const notification = new Notification(title, {
                    body: message,
                    icon: "{{ url_for('static', filename='images/chat-icon.png') }}"
                });

                // Focus on window when notification is clicked
                notification.onclick = function() {
                    window.focus();
                    notification.close();
                };
            }
        }

        // Handle visibility change to track if page is minimized/in background
        document.addEventListener('visibilitychange', function() {
            if (document.visibilityState === 'visible') {
                // Mark any unread messages as read when page becomes visible
                markMessagesAsRead();
            }
        });

        function markMessagesAsRead() {
            // You can implement logic here to mark messages as read
        }

        // Function to scroll to the bottom of the chat
        function scrollToBottom() {
            var chatMessages = document.getElementById('message-container');
            if (chatMessages) {
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
        }

        // Call scrollToBottom when the page loads
        document.addEventListener('DOMContentLoaded', function() {
            scrollToBottom();
        });

        // Socket connection events
        socket.on('connect', function() {
            console.log('Connected to WebSocket server');
            isConnected = true;

            // Rejoin room if reconnecting after disconnect
            socket.emit('join_room', {
                room_id: roomId,
                browser_uuid: browserUUID,
                stored_visitor_id: localStorage.getItem('visitor_id'),
                stored_room_id: sessionStorage.getItem(sessionStorageKey)
            });

            // Check if we need to update user details display
            if (localStorage.getItem('visitor_has_details') === 'true') {
                // Use localStorage values if available, otherwise fall back to server values
                const displayName = localStorage.getItem('visitor_name') || "{{ visitor.name|default('') }}";
                const displayEmail = localStorage.getItem('visitor_email') || "{{ visitor.email|default('') }}";

                updateUserDetailsDisplay(displayName, displayEmail);
            }
        });

        socket.on('disconnect', function() {
            console.log('Disconnected from WebSocket server');
            isConnected = false;
        });

        socket.on('reconnect', function(attemptNumber) {
            console.log('Reconnected to WebSocket server after ' + attemptNumber + ' attempts');
            isConnected = true;

            // Rejoin room
            socket.emit('join_room', {
                room_id: roomId,
                browser_uuid: browserUUID,
                stored_visitor_id: localStorage.getItem('visitor_id'),
                stored_room_id: sessionStorage.getItem(sessionStorageKey)
            });
        });

        socket.on('reconnect_attempt', function(attemptNumber) {
            console.log('Attempting reconnect: ' + attemptNumber);
        });

        socket.on('reconnect_error', function(error) {
            console.log('Reconnection error: ', error);
        });

        socket.on('reconnect_failed', function() {
            console.log('Failed to reconnect to WebSocket server');
        });

        // Typing indicator elements
        const adminTypingIndicator = document.getElementById('admin-typing-indicator');
        const aiTypingIndicator = document.getElementById('ai-typing-indicator');
        const visitorTypingIndicator = document.getElementById('visitor-typing-indicator');

        // Typing status variables
        let typingTimer;
        let isTyping = false;
        const typingTimeout = 3000; // 3 seconds

        // User details modal functionality
        var userDetailsModal = document.getElementById('user-details-modal');
        var successModal = document.getElementById('success-modal');
        var closeModalBtn = document.getElementById('close-modal');
        var closeSuccessModalBtn = document.getElementById('close-success-modal');
        var okSuccessBtn = document.getElementById('ok-success-btn');
        var cancelDetailsBtn = document.getElementById('cancel-details');
        var showDetailsModalBtn = document.getElementById('show-details-modal-btn');

        // Set initial values for visitor details if available
        var visitorNameInput = document.getElementById('visitor-name');
        var visitorEmailInput = document.getElementById('visitor-email');

        // First try to get values from localStorage
        const storedName = localStorage.getItem('visitor_name');
        const storedEmail = localStorage.getItem('visitor_email');

        // Then try from server-side data
        if (storedName) {
            visitorNameInput.value = storedName;
            hasVisitorName = true;
        } else if (hasVisitorName) {
            visitorNameInput.value = "{{ visitor.name|default('') }}";
            // Store in localStorage for future use
            localStorage.setItem('visitor_name', "{{ visitor.name|default('') }}");
        }

        if (storedEmail) {
            visitorEmailInput.value = storedEmail;
            hasVisitorEmail = true;
        } else if (hasVisitorEmail) {
            visitorEmailInput.value = "{{ visitor.email|default('') }}";
            // Store in localStorage for future use
            localStorage.setItem('visitor_email', "{{ visitor.email|default('') }}");
        }

        // Update visitorHasDetails flag
        visitorHasDetails = hasVisitorName || hasVisitorEmail;
        if (visitorHasDetails) {
            localStorage.setItem('visitor_has_details', 'true');
        }

        // Log the current state for debugging
        console.log('Initial visitor details state:', {
            hasVisitorName,
            hasVisitorEmail,
            visitorHasDetails,
            storedName,
            storedEmail,
            serverName: "{{ visitor.name|default('') }}",
            serverEmail: "{{ visitor.email|default('') }}"
        });

        function closeModal() {
            userDetailsModal.classList.add('hidden');
        }

        function closeSuccessModal() {
            successModal.classList.add('hidden');
        }

        closeModalBtn.addEventListener('click', closeModal);
        cancelDetailsBtn.addEventListener('click', closeModal);
        closeSuccessModalBtn.addEventListener('click', closeSuccessModal);
        okSuccessBtn.addEventListener('click', closeSuccessModal);

        // Close modals when clicking outside
        userDetailsModal.addEventListener('click', function(e) {
            if (e.target === userDetailsModal) {
                closeModal();
            }
        });

        successModal.addEventListener('click', function(e) {
            if (e.target === successModal) {
                closeSuccessModal();
            }
        });

        // Save user details
        document.getElementById('save-user-details').addEventListener('click', function() {
            var name = document.getElementById('visitor-name').value.trim();
            var email = document.getElementById('visitor-email').value.trim();

            // Validate email format if provided
            if (email && !isValidEmail(email)) {
                // Show error message instead of alert
                document.getElementById('email-error').classList.remove('hidden');
                return;
            }

            // Hide any previous error
            document.getElementById('email-error').classList.add('hidden');

            // Send user details to server with immediate flag
            socket.emit('update_visitor_details', {
                visitor_id: visitorId,
                browser_uuid: browserUUID,
                name: name,
                email: email,
                immediate_update: true // Add flag to indicate immediate update needed
            });

            // Close modal and show success message
            closeModal();

            // Show success modal instead of alert
            document.getElementById('success-message').textContent = 'Your details have been saved. Thank you!';
            successModal.classList.remove('hidden');

            // Update visitorHasDetails flag
            visitorHasDetails = true;

            // Store visitor details in localStorage for persistence
            localStorage.setItem('visitor_name', name);
            localStorage.setItem('visitor_email', email);
            localStorage.setItem('visitor_has_details', 'true');

            // Send updated details to parent window
            if (window.parent !== window) {
                window.parent.postMessage({
                    type: 'visitorDetailsUpdated',
                    name: name,
                    email: email
                }, '*');
            }
        });

        // Email validation function
        function isValidEmail(email) {
            var re = /^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
            return re.test(String(email).toLowerCase());
        }

        // SESSION-BASED ROOM ISOLATION: Use session-aware storage keys
        // Use the same session ID and storage key as defined above
        const joinRoomStorageKey = 'session_room_id_' + sessionId;

        // Join the room with session-based isolation
        socket.emit('join_room', {
            room_id: roomId,
            browser_uuid: browserUUID,
            stored_visitor_id: localStorage.getItem('visitor_id'),
            stored_room_id: sessionStorage.getItem(joinRoomStorageKey)
        });

        // Tell parent window our room ID, chat mode, and visitor details
        if (window.parent !== window) {
            window.parent.postMessage({
                type: 'roomId',
                roomId: roomId,
                chatMode: currentChatMode
            }, '*');

            // Send visitor details if available
            sendVisitorDetailsToParent();
        }

        // Function to send visitor details to parent window
        function sendVisitorDetailsToParent() {
            if (window.parent !== window) {
                // First try to get values from localStorage, then fall back to server values
                const visitorName = localStorage.getItem('visitor_name') || "{{ visitor.name|default('') }}";
                const visitorEmail = localStorage.getItem('visitor_email') || "{{ visitor.email|default('') }}";

                // Only send if we have actual content (not empty strings or "None")
                const hasName = visitorName && visitorName.trim() !== '' && visitorName.toLowerCase() !== 'none';
                const hasEmail = visitorEmail && visitorEmail.trim() !== '' && visitorEmail.toLowerCase() !== 'none';

                window.parent.postMessage({
                    type: 'visitorDetailsUpdated',
                    name: hasName ? visitorName : '',
                    email: hasEmail ? visitorEmail : ''
                }, '*');

                console.log('Sent visitor details to parent:', {
                    name: hasName ? visitorName : '',
                    email: hasEmail ? visitorEmail : ''
                });
            }
        }

        // Handle message sending
        document.getElementById('send-message-btn').addEventListener('click', function() {
            // Reset typing state
            if (isTyping) {
                isTyping = false;
                clearTimeout(typingTimer);
                socket.emit('visitor_stopped_typing', {
                    room_id: roomId,
                    visitor_id: visitorId
                });
            }
            sendMessage();
        });

        document.getElementById('message-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                // Reset typing state
                if (isTyping) {
                    isTyping = false;
                    clearTimeout(typingTimer);
                    socket.emit('visitor_stopped_typing', {
                        room_id: roomId,
                        visitor_id: visitorId
                    });
                }
                sendMessage();
            }
        });

        // Handle typing events
        document.getElementById('message-input').addEventListener('keydown', function(e) {
            // Don't trigger on special keys like shift, ctrl, etc.
            if (e.key === 'Shift' || e.key === 'Control' || e.key === 'Alt' ||
                e.key === 'Meta' || e.key === 'CapsLock' || e.key === 'Tab' ||
                e.key === 'ArrowUp' || e.key === 'ArrowDown' || e.key === 'ArrowLeft' || e.key === 'ArrowRight') {
                return;
            }

            // Always emit typing event on keydown, regardless of current state
                socket.emit('visitor_typing', {
                    room_id: roomId,
                    visitor_id: visitorId
                });

            isTyping = true;

            // Clear existing timer
            clearTimeout(typingTimer);

            // Set a new timer
            typingTimer = setTimeout(function() {
                isTyping = false;
                socket.emit('visitor_stopped_typing', {
                    room_id: roomId,
                    visitor_id: visitorId
                });
            }, typingTimeout);
        });

        // Handle admin typing events
        socket.on('admin_typing', function(data) {
            if (data.room_id === roomId) {
                console.log('Received admin typing event:', data);

                // Cancel any pending hide operations
                if (window.adminTypingHideTimer) {
                    clearTimeout(window.adminTypingHideTimer);
                    window.adminTypingHideTimer = null;
                }

                // Always update and show the typing indicator regardless of previous state
                const adminInitials = document.querySelector('#admin-typing-indicator .avatar-initials');
                const adminTypingName = document.querySelector('.admin-typing-name');

                // Update avatar if needed
                if (adminInitials) {
                    if (data.admin_profile_image) {
                        adminInitials.innerHTML = '';
                        const img = document.createElement('img');
                        img.src = data.admin_profile_image;
                        img.alt = data.admin_name || 'Admin';
                        img.style.width = '100%';
                        img.style.height = '100%';
                        img.style.objectFit = 'cover';
                        img.style.borderRadius = '50%';
                        adminInitials.appendChild(img);
                        adminInitials.className = 'profile-avatar';
                    } else {
                        // Just show initials
                        adminInitials.textContent = data.admin_name ? data.admin_name.charAt(0).toUpperCase() : 'A';
                        adminInitials.className = 'avatar-initials';
                    }
                }

                // Update name
                if (adminTypingName && data.admin_name) {
                    adminTypingName.textContent = data.admin_name;
                }

                // Force display to be visible - use !important to override any other styles
                adminTypingIndicator.style.cssText = 'display: flex !important;';

                // Scroll to show the typing indicator
                scrollToBottom();
            }
        });

        socket.on('admin_stopped_typing', function(data) {
            if (data.room_id === roomId) {
                console.log('Received admin stopped typing event:', data);

                // Hide the indicator after a short delay to prevent flickering
                // if typing events come in rapid succession
                if (window.adminTypingHideTimer) {
                    clearTimeout(window.adminTypingHideTimer);
                }

                window.adminTypingHideTimer = setTimeout(function() {
                    // Simply hide the indicator
                adminTypingIndicator.style.display = 'none';
                    window.adminTypingHideTimer = null;
                }, 100);
            }
        });

        // Handle AI typing events
        socket.on('ai_typing', function(data) {
            if (data.room_id === roomId) {
                aiTypingIndicator.style.display = 'flex';
                scrollToBottom();
            }
        });

        socket.on('ai_stopped_typing', function(data) {
            if (data.room_id === roomId) {
                aiTypingIndicator.style.display = 'none';
            }
        });

        function sendMessage() {
            var messageInput = document.getElementById('message-input');
            var messageContent = messageInput.value.trim();

            if (messageContent) {
                socket.emit('visitor_message', {
                    room_id: roomId,
                    visitor_id: visitorId,
                    browser_uuid: browserUUID,
                    message: messageContent
                });

                // Clear the input
                messageInput.value = '';

                // Hide typing indicators after sending a message
                adminTypingIndicator.style.display = 'none';
                aiTypingIndicator.style.display = 'none';
                visitorTypingIndicator.style.display = 'none';
            }
        }

        // Handle new message event
        socket.on('new_message', function(data) {
            if (data.room_id === roomId) {
                displayMessage(data);

                // Scroll to bottom after new message
                scrollToBottom();

                // Play notification sound ONLY for incoming messages (admin/AI messages)
                // AND only if the page is not visible (user is not actively viewing the chat)
                if (!data.is_from_visitor && document.visibilityState !== 'visible') {
                    playNotificationSound();

                    // Show browser notification for incoming messages
                    const senderName = data.is_ai_generated ? 'AI Assistant' : (data.sender_name || 'Support Agent');
                    showNotification(`New message from ${senderName}`, data.content);
                }
            }
        });

        // Handle system message event
        socket.on('system_message', function(data) {
            if (data.room_id === roomId) {
                displaySystemMessage(data.content, data.timestamp);

                // Scroll to bottom after system message
                scrollToBottom();
            }
        });

        // Handle visitor details updated event
        socket.on('visitor_details_updated', function(data) {
            if (data.room_id === roomId) {
                console.log('Visitor details updated:', data);

                // Update visitorHasDetails flag
                const hasName = data.name && data.name.trim() !== '' && data.name.toLowerCase() !== 'none';
                const hasEmail = data.email && data.email.trim() !== '' && data.email.toLowerCase() !== 'none';

                visitorHasDetails = hasName || hasEmail;

                // Update the input fields with the new details
                if (hasName && visitorNameInput) {
                    visitorNameInput.value = data.name;
                    // Store in localStorage
                    localStorage.setItem('visitor_name', data.name);
                }

                if (hasEmail && visitorEmailInput) {
                    visitorEmailInput.value = data.email;
                    // Store in localStorage
                    localStorage.setItem('visitor_email', data.email);
                }

                // Send updated details to parent window
                if (window.parent !== window) {
                    window.parent.postMessage({
                        type: 'visitorDetailsUpdated',
                        name: hasName ? data.name : '',
                        email: hasEmail ? data.email : ''
                    }, '*');
                }

                // Store in localStorage that user has provided details
                if (visitorHasDetails) {
                    localStorage.setItem('visitor_has_details', 'true');
                }

                // Log localStorage state for debugging
                console.log('localStorage after update:', {
                    visitor_name: localStorage.getItem('visitor_name'),
                    visitor_email: localStorage.getItem('visitor_email'),
                    visitor_has_details: localStorage.getItem('visitor_has_details')
                });
            }
        });

        // Handle chat mode changed event
        socket.on('chat_mode_changed', function(data) {
            if (data.room_id === roomId) {
                currentChatMode = data.mode;

                // Notify parent window about mode change
                if (window.parent !== window) {
                    window.parent.postMessage({
                        type: 'chatModeChanged',
                        mode: data.mode
                    }, '*');
                }

                // Update UI elements based on chat mode
                updateChatModeUI(data.mode);
            }
        });

        // Handle chat mode error event
        socket.on('chat_mode_error', function(data) {
            if (data.room_id === roomId) {
                // Show error message
                showNoAdminAvailableModal(data.error);

                // Notify parent window to reset toggle
                if (window.parent !== window) {
                    window.parent.postMessage({
                        type: 'adminUnavailable',
                        currentMode: data.current_mode
                    }, '*');
                }
            }
        });

        // Function to check if any admins are online before switching to human mode
        function checkAdminAvailabilityForHumanMode(callback) {
            fetch('/admin/api/check_human_mode_availability')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        callback(data.human_mode_available, data.reason);
                    } else {
                        console.error('Error checking human mode availability:', data.error);
                        callback(false, 'Error checking availability');
                    }
                })
                .catch(error => {
                    console.error('Error checking human mode availability:', error);
                    callback(false, 'Error checking availability');
                });
        }

        // Listen for messages from parent window (including chat mode toggle)
        window.addEventListener('message', function(event) {
            // Verify origin if needed

            if (event.data && event.data.type === 'toggleChatMode') {
                // If switching to human mode, check admin availability first
                if (event.data.mode === 'human') {
                    checkAdminAvailabilityForHumanMode(function(humanModeAvailable, reason) {
                        if (humanModeAvailable) {
                            // Proceed with mode change
                            socket.emit('change_chat_mode', {
                                room_id: roomId,
                                visitor_id: visitorId,
                                mode: event.data.mode
                            });
                        } else {
                            // Show popup message that human mode is not available
                            showNoAdminAvailableModal(reason);

                            // Send message back to parent to reset toggle
                            if (window.parent !== window) {
                                window.parent.postMessage({
                                    type: 'adminUnavailable',
                                    currentMode: currentChatMode
                                }, '*');
                            }
                        }
                    });
                } else {
                    // For AI mode, no need to check availability
                    socket.emit('change_chat_mode', {
                        room_id: roomId,
                        visitor_id: visitorId,
                        mode: event.data.mode
                    });
                }
            }
        });

        // Function to show "No admin available" modal with custom message
        function showNoAdminAvailableModal(reason) {
            const message = reason || "No admin is available right now. Please try again later.";

            // Create modal if it doesn't exist
            let modal = document.getElementById('no-admin-modal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'no-admin-modal';
                modal.className = 'modal';
                modal.innerHTML = `
                    <div class="modal-content">
                        <span class="close-modal">&times;</span>
                        <div class="text-center mb-4">
                            <div class="sad-face-emoji mb-2">😔</div>
                            <h3 class="text-red-500 font-bold">Human Support Unavailable</h3>
                        </div>
                        <p id="no-admin-message" class="text-center mb-4"></p>
                        <div class="text-center">
                            <p class="text-sm text-gray-600 mb-3">Our AI assistant is still available to help you.</p>
                            <button class="modal-btn">OK, I understand</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);

                // Add event listeners
                const closeBtn = modal.querySelector('.close-modal');
                const okBtn = modal.querySelector('.modal-btn');

                closeBtn.onclick = function() {
                    modal.style.display = 'none';
                };

                okBtn.onclick = function() {
                    modal.style.display = 'none';
                };

                window.onclick = function(event) {
                    if (event.target == modal) {
                        modal.style.display = 'none';
                    }
                };
            }

            // Set message and show modal
            document.getElementById('no-admin-message').textContent = message;
            modal.style.display = 'block';
        }

        // Function to update UI based on chat mode
        function updateChatModeUI(mode) {
            // Remove any existing mode messages
            const existingModeMessages = document.querySelectorAll('.bg-blue-50, .bg-amber-50');
            existingModeMessages.forEach(function(element) {
                element.remove();
            });

            // No need to add new mode messages here as they'll come through the system_message event
        }

        // Function to format Google Meet links
        function formatGoogleMeetLinks(message) {
            // Regex to detect Google Meet links
            const googleMeetRegex = /(https?:\/\/(meet\.google\.com\/[a-zA-Z0-9\-_]+))/gi;

            // Check if the message contains a Google Meet link
            if (googleMeetRegex.test(message)) {
                // Replace Google Meet links with formatted button
                return `<div class="bg-white rounded-xl shadow-md p-4 my-3">
                    <p class="text-sm mb-3" style="color: #0F4173;">
                        Please join our live Google Meet to continue the discussion:
                    </p>
                    <a href="${message}" target="_blank" class="inline-flex items-center px-4 py-2 text-sm font-medium rounded-lg transition-colors duration-200" style="background-color: #0F4173; color: white;">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                        </svg>
                        Join Meet
                    </a>
                </div>`;
            }
            return message;
        }

        // Function to display messages
        function displayMessage(data) {
            var messageContainer = document.getElementById('message-container');

            // Create message container
            var messageWrapper = document.createElement('div');
            messageWrapper.className = 'message-container ' +
                (data.is_from_visitor ? 'justify-end' : '');

            // Add avatar for non-visitor messages
            if (!data.is_from_visitor) {
                var avatarElement;

                if (data.sender_name === 'AI Assistant' || data.is_ai_generated) {
                    avatarElement = document.createElement('div');
                    avatarElement.className = 'avatar-initials ai-avatar';

                    var robotIcon = document.createElement('span');
                    robotIcon.className = 'material-icons';
                    robotIcon.textContent = 'smart_toy';
                    avatarElement.appendChild(robotIcon);
                } else {
                    if (data.admin_profile_image) {
                        avatarElement = document.createElement('div');
                        avatarElement.className = 'profile-avatar';

                        var img = document.createElement('img');
                        img.src = data.admin_profile_image;
                        img.alt = data.sender_name;

                        avatarElement.appendChild(img);
                    } else {
                        avatarElement = document.createElement('div');
                        avatarElement.className = 'avatar-initials';
                        avatarElement.textContent = data.sender_name ? data.sender_name.charAt(0).toUpperCase() : 'A';
                    }
                }

                messageWrapper.appendChild(avatarElement);
            }

            // Create message bubble
            var messageBubble = document.createElement('div');

            if (data.is_from_visitor) {
                messageBubble.className = 'max-w-[75%] rounded-lg px-4 py-3 shadow-soft bg-primary-100 text-primary-900';
            } else if (data.sender_name === 'AI Assistant' || data.is_ai_generated) {
                messageBubble.className = 'max-w-[75%] rounded-lg px-4 py-3 shadow-soft bg-secondary-100 text-secondary-900';
            } else {
                messageBubble.className = 'max-w-[75%] rounded-lg px-4 py-3 shadow-soft bg-primary-600 text-white';
            }

            // Create message content container
            var contentDiv = document.createElement('div');
            contentDiv.className = 'flex flex-col';

            // Create message header with sender name and time
            var headerDiv = document.createElement('div');
            headerDiv.className = 'message-header';

            var senderName = document.createElement('span');
            senderName.className = 'message-sender';
            senderName.textContent = data.is_from_visitor ? 'You' : data.sender_name;

            // Create time element
            const timeElement = document.createElement('span');
            timeElement.className = 'message-time';
            timeElement.setAttribute('data-timestamp', data.timestamp);
            timeElement.setAttribute('data-format', currentTimeFormat);

            // Format timestamp immediately using current timezone and format (async)
            timeElement.textContent = 'Loading...'; // Temporary text while formatting
            formatTimestamp(data.timestamp, currentTimeFormat).then(formattedTime => {
                timeElement.textContent = formattedTime || '';
            }).catch(error => {
                console.error('Error formatting timestamp in displayMessage:', error);
                timeElement.textContent = '';
            });

            // Assemble header
            headerDiv.appendChild(senderName);
            headerDiv.appendChild(timeElement);

            // Create message text
            var messageText = document.createElement('p');
            messageText.className = 'text-sm';

            // Check if this is a Google Meet link and format it
            const formattedContent = formatGoogleMeetLinks(data.content);
            if (formattedContent !== data.content) {
                // It's a Google Meet link, use innerHTML
                messageText.innerHTML = formattedContent;
            } else {
                // Regular message, use textContent
                messageText.textContent = data.content;
            }

            // Assemble the message
            contentDiv.appendChild(headerDiv);
            contentDiv.appendChild(messageText);
            messageBubble.appendChild(contentDiv);

            messageWrapper.appendChild(messageBubble);

            // Add visitor avatar if it's a visitor message
            if (data.is_from_visitor) {
                var visitorAvatar = document.createElement('div');
                visitorAvatar.className = 'avatar-initials visitor-avatar';
                visitorAvatar.textContent = 'You';
                messageWrapper.appendChild(visitorAvatar);
            }

            // Add to message container
            var messagesDiv = messageContainer.querySelector('.space-y-4');
            if (!messagesDiv) {
                messagesDiv = document.createElement('div');
                messagesDiv.className = 'space-y-4';
                messageContainer.appendChild(messagesDiv);
            }

            messagesDiv.appendChild(messageWrapper);

            // Scroll to bottom
            scrollToBottom();
        }

        // Function to display system messages
        function displaySystemMessage(content, timestamp) {
            var messageContainer = document.getElementById('message-container');

            // Create system message element
            var systemMessageDiv = document.createElement('div');
            systemMessageDiv.className = 'system-message';

            var systemMessageContent = document.createElement('div');
            systemMessageContent.className = 'system-message-content';

            // Format the content to make it more elegant
            // Remove any existing HTML formatting
            let plainContent = content.replace(/<\/?[^>]+(>|$)/g, "");

            // Create a clean display with proper formatting
            systemMessageContent.textContent = plainContent;

            var timeSpan = document.createElement('span');
            timeSpan.className = 'system-message-time';
            timeSpan.setAttribute('data-timestamp', timestamp);

            // Format the timestamp (async)
            timeSpan.textContent = 'Loading...'; // Temporary text while formatting
            formatTimestamp(timestamp, currentTimeFormat).then(formattedTime => {
                timeSpan.textContent = formattedTime || '';
            }).catch(error => {
                console.error('Error formatting system timestamp:', error);
                timeSpan.textContent = '';
            });

            systemMessageContent.appendChild(timeSpan);
            systemMessageDiv.appendChild(systemMessageContent);

            // Find the right place to insert the message
            var messagesDiv = messageContainer.querySelector('.space-y-4');
            if (!messagesDiv) {
                // If there's no messages container yet, create one
                messagesDiv = document.createElement('div');
                messagesDiv.className = 'space-y-4';
                messageContainer.appendChild(messagesDiv);
            }

            // Add to messages container - append at the end
            messagesDiv.appendChild(systemMessageDiv);

            // Scroll to bottom
            scrollToBottom();
        }

        // Function to play notification sound
        function playNotificationSound() {
            // Create audio element if it doesn't exist
            let notificationSound = document.getElementById('notification-sound');
            if (!notificationSound) {
                notificationSound = document.createElement('audio');
                notificationSound.id = 'notification-sound';
                notificationSound.src = "{{ url_for('static', filename='sounds/notification.mp3') }}";
                notificationSound.preload = 'auto';
                document.body.appendChild(notificationSound);
            }

            // Play sound
            notificationSound.play().catch(error => {
                console.log('Could not play notification sound:', error);
            });
        }

        // SESSION-BASED CHAT ISOLATION: Updated visitor status check
        function checkVisitorStatus() {
            // SESSION-BASED STORAGE: Use session-aware storage
            const storedVisitorId = localStorage.getItem('visitor_id');
            const browserUUID = localStorage.getItem('browser_uuid');

            // Generate session ID if not exists
            let sessionId = sessionStorage.getItem('session_id');
            if (!sessionId) {
                sessionId = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                sessionStorage.setItem('session_id', sessionId);
            }

            const sessionStorageKey = 'session_room_id_' + sessionId;
            const storedRoomId = sessionStorage.getItem(sessionStorageKey);

            // Send request to check visitor status
            fetch('/api/check_visitor', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    visitor_id: "{{ visitor_id }}",
                    browser_uuid: browserUUID,
                    stored_visitor_id: storedVisitorId,
                    stored_room_id: storedRoomId
                }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Store the visitor ID in localStorage (persists across sessions)
                    localStorage.setItem('visitor_id', data.visitor_id);

                    // Store room ID in session-specific storage
                    sessionStorage.setItem(sessionStorageKey, data.room_id);

                    // SESSION-BASED ISOLATION: Only redirect if we're in the wrong room for this session
                    // AND the room actually belongs to a different session
                    if (data.room_id !== "{{ room.id }}") {
                        console.log('Room ID mismatch detected:', {
                            current: "{{ room.id }}",
                            expected: data.room_id,
                            session: sessionId
                        });

                        // Only redirect if this is a legitimate room change for this session
                        // Avoid infinite redirects by checking if we've already tried this
                        const redirectKey = 'redirect_attempted_' + sessionId;
                        if (!sessionStorage.getItem(redirectKey)) {
                            sessionStorage.setItem(redirectKey, 'true');
                            window.location.href = '/chat_iframe/' + data.room_id;
                        }
                    } else {
                        // Clear any redirect flags if we're in the correct room
                        const redirectKey = 'redirect_attempted_' + sessionId;
                        sessionStorage.removeItem(redirectKey);
                    }
                }
            })
            .catch(error => {
                console.error('Error checking visitor status:', error);
            });
        }

        // Call checkVisitorStatus on page load
        document.addEventListener('DOMContentLoaded', function() {
            checkVisitorStatus();
            scrollToBottom();
        });

        // Listen for messages from parent window
        window.addEventListener('message', function(event) {
            // Make sure the message is from our parent window
            if (event.source === window.parent) {
                const data = event.data;

                // Handle openDetailsModal message
                if (data.type === 'openDetailsModal') {
                    userDetailsModal.classList.remove('hidden');
                }
            }
        });
    </script>
</body>
</html>